<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- vscode Session 373d0851-4e82-4f2e-bfac-1cd0ad364af5 (2025-11-27 15:17Z) -->

# pdrias revisar el proyecto completo y decirme el flujo de extracci√≥n de los expedientes en formato PDF  (2025-11-27 15:17Z)

_**User (2025-12-02 02:46Z)**_

pdrias revisar el proyecto completo y decirme el flujo de extracci√≥n de los expedientes en formato PDF 

---

_**Agent**_



---

_**User (2025-12-02 02:47Z)**_

podrias ayudarme?

---

_**Agent (model copilot/claude-haiku-4.5)**_

[object Object]

---

_**User (2025-12-02 02:47Z)**_

@agent Enable: "Enable Claude Haiku 4.5 for all clients"

---

_**Agent (model copilot/claude-haiku-4.5)**_

Claro, estoy aqu√≠ para ayudarte. 

Por favor, cu√©ntame qu√© necesitas. Vi que tu proyecto EGRESAPP2 parece ser una aplicaci√≥n para gestionar expedientes de egresados. ¬øQu√© espec√≠ficamente necesitas que revise o que haga?

Algunas opciones que veo:
- Revisar el flujo de extracci√≥n de expedientes en PDF
- Analizar la estructura del proyecto
- Debugging de alg√∫n problema espec√≠fico
- Implementar una nueva funcionalidad
- Otro problema

¬øCu√°l es tu necesidad exacta?

---

_**User (2025-12-02 02:48Z)**_

quiero que me digas como laplataforma extrae de ,amera interna los datos de los expedientes

---

_**Agent (model copilot/claude-haiku-4.5)**_

Entendido. Voy a revisar el proyecto para explicarte c√≥mo la plataforma extrae datos de los expedientes desde la c√°mara interna. Perfecto. Ahora voy a revisar los componentes clave para entender el flujo completo: Continuemos con m√°s detalles: Perfecto. Ahora tengo el panorama completo. Te presento el flujo de extracci√≥n de datos de los expedientes desde c√°mara/PDF:

## üìã Flujo de Extracci√≥n de Expedientes - EGRESAPP2

### **1. CAPTURA INICIAL**
- El usuario sube un **PDF** desde la interfaz (`adm_egresado.php`)
- O importa desde **Google Drive** (si est√° habilitado)
- El archivo se env√≠a a `ProcesarExpedienteController.php`

### **2. ALMACENAMIENTO TEMPORAL**
```
Archivo ‚Üí /assets/expedientes/expedientes_subidos/
         ‚Üí Se valida que sea PDF v√°lido
         ‚Üí Se genera nombre √∫nico
```

### **3. ENCOLAMIENTO EN QUEUE**
El sistema usa `ExpedienteQueue` (tabla en BD):
- Estado: `pending` ‚Üí `processing` ‚Üí `done`/`failed`
- Permite procesamiento as√≠ncrono
- Reintenta hasta 3 veces si falla

### **4. EXTRACCI√ìN OCR (Multi-capa)**

**`PDFProcessor::extractStructuredData()` usa 4 m√©todos en cascada:**

#### A) **Spatie/PdfToText** (pdftotext)
- Extrae texto directo del PDF
- R√°pido, sin OCR
- Funciona si el PDF tiene texto embebido

#### B) **Smalot/PdfParser** 
- Parsea la estructura interna del PDF
- Extrae capas de texto

#### C) **PaddleOCR** (Python + `ocr_paddle.py`)
```
PDF ‚Üí convert_from_path() ‚Üí Imagen 300 DPI
    ‚Üí PaddleOCR (espa√±ol) ‚Üí Texto OCR
```

#### D) **Tesseract OCR** (Fallback)
```
PDF ‚Üí ImageMagick ‚Üí Im√°genes
    ‚Üí Tesseract (OCR) ‚Üí Texto
```

### **5. PROCESAMIENTO CON IA LOCAL**

**Script: `ocr_ai_parser.py`**

```python
1. Renderiza primera p√°gina en 300 DPI
2. Ejecuta PaddleOCR en espa√±ol
3. Env√≠a texto a Ollama (IA local)
   - Modelo: "deepseek-coder-v2"
   - Extrae campos JSON estructurados
4. Normaliza fechas, RUT, n√∫meros certificado
```

**Campos extra√≠dos:**
- `rut`: Normaliza formato (XX.XXX.XXX-X)
- `nombre_completo`: May√∫sculas, sin acentos duplicados
- `anio_egreso`: Solo n√∫meros
- `titulo`: Especialidad/Titulo
- `numero_certificado`: Formato "XX-XXX"
- `fecha_entrega`: Formato ISO (yyyy-mm-dd)

### **6. VALIDACI√ìN Y FUSI√ìN DE DATOS**

```php
if (AI_fields encontrados) {
    resultado = AI_fields + informaci√≥n del texto directo
} else {
    resultado = solo informaci√≥n del texto directo
}

// Si solo hay a√±o de egreso
si (anio_egreso && !fecha_egreso) {
    fecha_egreso = anio_egreso + "-01-01"
}
```

### **7. RESPUESTA AL FRONTEND**

En `ProcesarExpedienteController.php`:

```json
{
  "success": true,
  "mensaje": "Expediente procesado correctamente",
  "datos": {
    "rut": "18.315.067-7",
    "nombre": "GUISELLE CORAL PINA MOLLO",
    "fecha_egreso": "2010-01-01",
    "numero_certificado": "00-327",
    "titulo": "T√©cnico De Nivel Medio En Administraci√≥n"
  },
  "estado": "done"
}
```

### **8. INTERFAZ DE VALIDACI√ìN**

En `adm_egresado.php`:
- Muestra campos extra√≠dos en **formulario editable**
- Si faltan datos ‚Üí Bot√≥n "No reconocido" para entrada manual
- Usuario valida/edita antes de guardar
- Frontend (`egresado.js`) habilita botones seg√∫n campos completos

### **9. ALMACENAMIENTO FINAL**

```php
// ExpedienteProcessor.php
- Guarda archivo PDF en ubicaci√≥n final
- Actualiza tabla egresado con:
  * RUT, nombre completo
  * A√±o/fecha de egreso
  * N√∫mero de certificado
  * Referencia al archivo PDF
```

### **10. GESTI√ìN DE ERRORES**

```
Si OCR incompleto (sin RUT + nombre)
  ‚Üí Estado: "failed"
  ‚Üí Reintenta hasta 3 veces
  ‚Üí Permite edici√≥n manual
  ‚Üí Genera logs en /assets/expedientes/debug_datos.txt
```

---

### **‚öôÔ∏è Configuraci√≥n requerida:**
- `pdf.php`: Rutas de Python, Poppler, Tesseract
- Ollama corriendo en `http://localhost:11434`
- PaddleOCR instalado (`pip install paddleocr`)
- Tesseract + ImageMagick (opcional, como fallback)

¬øNecesitas detalles de alg√∫n paso espec√≠fico o ayuda con alguna parte del flujo?

---

_**User (2025-12-02 02:54Z)**_

este proyecto necesita ghostcript?

---

_**Agent (model copilot/claude-haiku-4.5)**_

Voy a revisar el proyecto para ver si usa Ghostscript: Ahora voy a buscar referencias a ImageMagick y conversi√≥n de PDF a im√°genes: Ahora voy a buscar referencias expl√≠citas a Ghostscript: Perfecto. Ahora voy a ver la funci√≥n que detecta ImageMagick: Perfecto. Ahora tengo la respuesta completa. Voy a crear un resumen claro:

## **¬øNecesita Ghostscript?**

**No, el proyecto NO necesita Ghostscript directamente**, pero necesita **ImageMagick** que internamente usa Ghostscript.

### üìã Dependencias actuales del proyecto:

| Herramienta | Prop√≥sito | ¬øUsado? | ¬øNecesario? |
|---|---|---|---|
| **ImageMagick** | Convertir PDF ‚Üí im√°genes PNG (300 DPI) | ‚úÖ S√≠ | ‚úÖ S√≠ (fallback OCR) |
| **Ghostscript** | Motor renderizaci√≥n de PDFs en ImageMagick | üì¶ Indirecto | ‚úÖ S√≠ (si usas ImageMagick) |
| **Tesseract OCR** | Extracci√≥n OCR del texto de im√°genes | ‚úÖ S√≠ | ‚úÖ S√≠ (fallback) |
| **Python 3.10** | Ejecutar scripts OCR con PaddleOCR | ‚úÖ S√≠ | ‚ö†Ô∏è Opcional (deshabilitado actualmente) |
| **Poppler** | Extracci√≥n de texto de PDFs (pdftotext) | ‚úÖ S√≠ | ‚úÖ S√≠ (primera opci√≥n) |
| **Ollama** | IA local para parsear datos estructurados | ‚ö†Ô∏è Opcional | ‚ö†Ô∏è Opcional (deshabilitado) |

### üîÑ Flujo de extracci√≥n actual (con herramientas instaladas):

```
1. Poppler/pdftotext      ‚Üê Intenta primero (r√°pido)
2. Smalot PDFParser       ‚Üê Si falla, usa parser PHP
3. PaddleOCR (Python)     ‚Üê Si falla, usa OCR en Python (actualmente deshabilitado)
4. ImageMagick + Tesseract‚Üê √öltimo recurso si todo falla
   ‚îî‚îÄ Requiere Ghostscript
```

### ‚úÖ Estado actual en `pdf.php`:

```php
'enable_paddle_ocr' => false,     // Deshabilitado - no necesita Python/PaddleOCR
'enable_ai_parser' => false,      // Deshabilitado - no necesita Ollama
```

Esto significa que **actualmente solo necesitas**:
- ‚úÖ **Poppler** (ya configurado)
- ‚úÖ **Tesseract** (para fallback)
- üì¶ **ImageMagick + Ghostscript** (juntos, para fallback de ImageMagick)

¬øNecesitas que active el OCR con Python o que instale/configure algo espec√≠fico?

---

_**User (2025-12-02 03:30Z)**_

quiero que de manera profesional hagas un instalador que re√∫na todas las dependencias que actualmente usa el sistema y que no arroje errores en la instalaci√≥n para poder probar el sistema en otro PC. Hay que actualizar el token de OAuth2 de google drive ya que se venci√≥ el permiso.

se debe instalar de manera automatizada lo siguiente:

Laragon (va a pedir iniciar todos los servicios, asi que automatiza eso) + ImageMagick + Ghostscript (como est√° implementado aqu√≠)
LibreOffice
poppler
Tesseract OCR

El instalador debe informar todo lo que est√° haciendo, incorporar la base de datos que ya tiene la plataforma, es decir, cargarla con heidi en laragon de manera autom√°tica.

Tendr√°s problemas con el usuario y la clave:

El  usuario es "admin@test.com y la pass "12345678"

si arroja error al ingresar es porque en la base de datos la contrase√±a tiene la √ë o bien la clave est√° con un script.

puede que te pida la tabla de "gestion", esa ya no existe.

Despues de instalar todo, el instalador deber√≠a dejar listo un icono de la aplicaci√≥n, que al hacer doble click se pueda ejecutar todo incluyendo laragon

---

_**Agent (model copilot/claude-haiku-4.5)**_

Perfecto. Voy a crear un instalador profesional y completo. Primero, d√©jame revisar la estructura actual del proyecto para obtener todos los detalles necesarios. 

---

